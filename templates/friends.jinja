{% extends 'base.jinja' %}

{% block content %}

<div id="friend-requests-container">
  <!-- Friend requests will be displayed here -->
</div>

<h2>Friends List</h2>
<table id="friends-list" style="border: 1px solid black">
  <tr>
    <th style="background-color: yellow;">Friends</th>
  </tr>
  {% for friend in friends_list %}
    <tr>
      <td style="border: 1px solid black">{{ friend }}</td>
    </tr>
  {% endfor %}
</table>

<h2>Add a New Friend</h2>
<form id="friend-form">
  <label for="enter_value">Friend's Username:</label><br>
  <input type="text" id="enter_value" name="enter_value">
  <input type="submit" value="Submit">
</form>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <ul>
    {% for message in messages %}
      <li>{{ message }}</li>
    {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Function to fetch and display friend requests
    function fetchAndDisplayFriendRequests() {
        fetch("{{ url_for('fetch_friend_requests') }}")
        .then(response => response.json())
        .then(data => {
            const requestsContainer = document.getElementById('friend-requests-container');
            if (data && data.requests) {
                data.requests.forEach(request => {
                    const requestElement = document.createElement('div');
                    requestElement.textContent = request.fromUser;

                    const acceptButton = document.createElement('button');
                    acceptButton.textContent = 'Accept';
                    acceptButton.addEventListener('click', function() {
                        const acceptUrl = `/accept-friend-request/${request.id}`;
                        fetch(acceptUrl, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            requestElement.remove();  // Remove the request element from the DOM
                        })
                        .catch(error => console.error('Error:', error));
                    });

                    const declineButton = document.createElement('button');
                    declineButton.textContent = 'Decline';
                    declineButton.addEventListener('click', function() {
                        const declineUrl = `/reject-friend-request/${request.id}`;
                        fetch(declineUrl, { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            requestElement.remove();  // Remove the request element from the DOM
                        })
                        .catch(error => console.error('Error:', error));
                    });

                    requestElement.appendChild(acceptButton);
                    requestElement.appendChild(declineButton);
                    requestsContainer.appendChild(requestElement);
                });
            } else {
                console.log('No friend requests found.');
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Call the function to fetch and display friend requests
    fetchAndDisplayFriendRequests();

    const friendForm = document.getElementById('friend-form');
    friendForm.addEventListener('submit', function(event) {
        event.preventDefault(); 
        const friendUsername = document.getElementById('enter_value').value;
        const senderUsername = '{{ username }}';
        fetch("{{ url_for('send_friend_request') }}"), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ sender: senderUsername, receiver: friendUsername })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);  // Show a message to the user
            if (data.success) {
                const friendsList = document.getElementById('friends-list');
                const newRow = friendsList.insertRow();
                newRow.innerHTML = `<td>${friendUsername}</td>`;  // Add the new friend to the list
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>


{% endblock %}
